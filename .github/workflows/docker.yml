name: Build & Deploy Docker

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch: {}

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: ${{ vars.REGISTRY || 'docker.io' }}
      IMAGE_REPO: ${{ vars.IMAGE_REPO || 'journey1019/depromeet-team3' }}

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Extract short SHA
        id: vars
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build & Push Docker Image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:sha-${{ steps.vars.outputs.SHORT_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_KAKAO_APP_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_APP_KEY }}
            NEXT_PUBLIC_KAKAO_CLIENT_ID=${{ secrets.NEXT_PUBLIC_KAKAO_CLIENT_ID }}
            NEXT_PUBLIC_KAKAO_REDIRECT_URL=${{ secrets.NEXT_PUBLIC_KAKAO_REDIRECT_URL }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Show pushed digest
        run: |
          echo "========================================="
          echo "Docker Image Build Complete"
          echo "========================================="
          echo "Digest: ${{ steps.build.outputs.digest }}"
          echo "Image Tags:"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:sha-${{ steps.vars.outputs.SHORT_SHA }}"
          echo "========================================="

  deploy-prod:
    name: Deploy to PROD (self-hosted)
    needs: docker
    runs-on: [self-hosted, Linux, X64]
    if: github.ref == 'refs/heads/main'
    environment: production

    env:
      PROJECT_DIR: ${{ secrets.PROD_PROJECT_DIR }}
      REGISTRY: ${{ vars.REGISTRY || 'docker.io' }}
      IMAGE_REPO: ${{ vars.IMAGE_REPO || 'journey1019/depromeet-team3' }}
      IMAGE: ${{ vars.IMAGE_REPO || 'journey1019/depromeet-team3' }}:latest

    steps:
      - name: Docker Login
        run: echo '${{ secrets.REGISTRY_PASSWORD }}' | docker login "$REGISTRY" -u '${{ secrets.REGISTRY_USER }}' --password-stdin

      - name: Deploy latest image
        run: |
          COMPOSE_FILE="$PROJECT_DIR/module-infrastructure/nextjs/compose.yaml"
          IMAGE_NAME="${IMAGE_REPO}:latest"

          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "âŒ ERROR: Compose file not found at $COMPOSE_FILE"
            exit 1
          fi

          echo "========================================="
          echo "ë°°í¬ ì‹œì‘"
          echo "========================================="
          
          echo "âœ… Compose file found"
          
          echo ""
          echo "ğŸ” compose.yamlì˜ ì´ë¯¸ì§€ ì„¤ì •:"
          grep -A 2 "image:" "$COMPOSE_FILE"
          
          echo ""
          echo "ğŸ” IMAGE í™˜ê²½ë³€ìˆ˜ ì„¤ì •: ${IMAGE}"
          
          echo ""
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
          docker compose -f "$COMPOSE_FILE" down || true
          
          echo ""
          echo "ğŸ§¹ ì´ë¯¸ì§€ ìºì‹œ ì‚­ì œ..."
          docker image rm -f "$IMAGE_NAME" || true
          docker image rm -f "${IMAGE_REPO}:sha-"* || true
          
          echo ""
          echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ëª…ì‹œì  Pull..."
          docker pull "$IMAGE_NAME"
          
          echo ""
          echo "ğŸ” Pull í›„ ì´ë¯¸ì§€:"
          docker images "$IMAGE_NAME" --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}"
          
          echo ""
          echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ (IMAGE=${IMAGE})..."
          export IMAGE="${IMAGE}"
          docker compose -f "$COMPOSE_FILE" up -d web
          
          echo ""
          echo "âœ… ë°°í¬ ì™„ë£Œ. í˜„ì¬ ìƒíƒœ:"
          docker ps --filter "name=web" --format "table {{.Names}}\t{{.Image}}\t{{.CreatedAt}}\t{{.Status}}"
          
          echo ""
          echo "ğŸ” ê²€ì¦: ì‹¤ì œ ì‚¬ìš© ì¤‘ì¸ ì´ë¯¸ì§€ í™•ì¸"
          RUNNING_IMAGE=$(docker inspect deploy-web-1 --format='{{.Config.Image}}')
          RUNNING_IMAGE_ID=$(docker inspect deploy-web-1 --format='{{.Image}}' | cut -d':' -f2 | cut -c1-12)
          LATEST_IMAGE_ID=$(docker images "$IMAGE_NAME" --format "{{.ID}}")
          
          echo "ì„¤ì •ëœ ì´ë¯¸ì§€ëª…: ${RUNNING_IMAGE}"
          echo "ì‹¤í–‰ ì¤‘ ì´ë¯¸ì§€ ID: ${RUNNING_IMAGE_ID}"
          echo "latest ì´ë¯¸ì§€ ID: ${LATEST_IMAGE_ID}"
          
          if [ "${RUNNING_IMAGE_ID}" = "${LATEST_IMAGE_ID}" ]; then
            echo "âœ… ìµœì‹  ì´ë¯¸ì§€ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
          else
            echo "âŒ ê²½ê³ : ì˜ˆì „ ì´ë¯¸ì§€ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "========================================="